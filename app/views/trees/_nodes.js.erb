Node.prototype = new BasicNode();
Node.prototype.constructor = Node;
function Node(opts) {
	this.basicInit(opts.id, opts.theta, opts.caseMarker);
	this._traceId = undefined;
	
	var node = this.createSkeleton(opts.pos);
	
	var content = document.createElement('span');
	if(opts.contents != undefined)
		content.innerHTML = opts.contents;
	
	var trace = document.createElement('sub');
	trace.className = "trace";
	
	var container = document.createElement('div');
	
	container.appendChild(content);
	container.appendChild(trace);
	node.appendChild(container);
	
	mainCanvas.appendChild(node);
	
	this._$content = $(content);
	this._$trace = $(trace);
	this._$container = $(container);
	
	this.makeEditable(this._$content, this._EMPTY_CONTENT);
	
	this.move(opts.x, opts.y);
	if(SAVER != undefined)
		SAVER.signalModification(this.id);
}

Node.prototype.simplify = function() {
	var simple = {
		id: this.id,
		pid: this._pid,
		x: parseInt(this._$node.css("left")),
		y: parseInt(this._$node.css("top")),
		"case": this._case,
		theta: this._theta,
		trace_id: this._traceId,
		type: "Node"
	}
	
	if(this._$pos[0].innerHTML != this._EMPTY_POS)
		simple["pos"] = this._$pos[0].innerHTML;
		
	if(this._$content[0].innerHTML != this._EMPTY_CONTENT)
		simple["content"] = this._$content[0].innerHTML;
		
	return simple;
}

Node.prototype.isEditing = function() {
	return (this._$pos.is(":editing") || this._$content.is(":editing"))
}

Node.prototype.stopEditing = function() {
	if(this._$pos.is(":editing"))
		this._$pos.editable("close");
		
	if(this._$content.is(":editing"))
		this._$content.editable("close");
}

Node.prototype.hideContent = function() {
	this._$container.css("display", "none");
	this.hasMoved();
}

Node.prototype.showContent = function() {
	this._$container.css("display", "block");
	this.hasMoved();
}

Node.prototype.toggleContent = function() {
	if(this._$container.css("display") == "none")
		this.showContent();
	else
		this.hideContent();
}

Node.prototype.remove = function() {
	if(this._traceId != undefined)
		NODES[this._traceId].traceeRemoved();
	
	BasicNode.prototype.remove.call(this);
}

Node.prototype.spawnChild = function(isTrace) {
	var center = this.getCanvasRelativeCenter();
	
	//TODO use actual border width
	var newNode;
	if(isTrace) {
		newNode = new Trace(ID_COUNTER, 10, 10, Trace.generateId());
	} else {
		newNode = new Node(ID_COUNTER, 10, 10);
	}
	newNode.setParent(this.id);
	this._chids[newNode.id] = true;
	
	newNode.move(center.x - newNode.getDimensions().x / 2, center.y + 50);

	NODES[ID_COUNTER] = newNode;
	
	ID_COUNTER += 1;
	this.signalModification();
	
	this.hideContent();
	$(mainCanvas).selectable("refresh");
}

Node.prototype.removeChild = function(chid) {
	delete this._chids[chid];
	//Line is taken care of by child
	
	//Show our content if we have no more children
	var count = 0;
	for(chid in this._chids)
		count++;
		
	if(count == 0)
		this.showContent();
}

Node.prototype.linkNewChild = function(chid) {
	this._chids[chid] = true;
	NODES[chid].setParent(this.id); //Child signals its modification here
	this.signalModification();
	
	this.hideContent();
}

Node.prototype.linkTrace = function(traceId) {
	this._traceId = traceId;
	this._$trace[0].innerHTML = NODES[traceId].traceId;
	
	this.signalModification();
}

Node.prototype.traceRemoved = function() {
	this._traceId = undefined;
	this._$trace[0].innerHTML = "";
	
	this.signalModification();
}

Trace.prototype = new BasicNode();
Trace.prototype.constructor = Trace;
function Trace(opts) {
	this.basicInit(opts.id, opts.theta, opts.caseMarker);
	this.traceId = opts.traceId;
	this._traceeId = undefined;
	
	var node = this.createSkeleton(opts.pos);
	
	var trace = document.createElement('div');
	trace.innerHTML = "<i>t</i><sub>" + traceId + "</sub>";
	
	node.appendChild(trace);
	mainCanvas.appendChild(node);
	
	this.move(opts.x, opts.y);
	if(SAVER != undefined)
		SAVER.signalModification(this.id);
}

Trace.generateId = function() {
	
	var maxId = MAX_TRACE_ID.charCodeAt(0);
	var start = "i".charCodeAt(0);
	
	var ids = [];
	allTraces(function(tr) {
		ids[tr.traceId.charCodeAt(0) - start] = true;
	});
	
	for(i = 0 ; i <= (maxId - start) ; i++) {
		if(ids[i] === undefined)
			return String.fromCharCode(i + start);
	}
	
	MAX_TRACE_ID = String.fromCharCode(maxId + 1);
	return MAX_TRACE_ID;
}

Trace.prototype.simplify = function() {
	var simple = {
		id: this.id,
		pid: this._pid,
		x: parseInt(this._$node.css("left")),
		y: parseInt(this._$node.css("top")),
		trace_idx: this.traceId,
		"case": this._case,
		theta: this._theta,
		type: "Trace"
	}
	
	if(this._$pos[0].innerHTML != this._EMPTY_POS)
		simple["pos"] = this._$pos[0].innerHTML;
		
	return simple;
}

Trace.prototype.isEditing = function() {
	return this._$pos.is(":editing");
}

Trace.prototype.stopEditing = function() {
	if(this._$pos.is(":editing"))
		this._$pos.editable("close");
}

Trace.prototype.remove = function() {
	if(this._traceeId != undefined)
		NODES[this._traceeId].traceRemoved();
	
	BasicNode.prototype.remove.call(this);
}

Trace.prototype.linkTracee = function(traceeId) {
	this._traceeId = traceeId;
	
	this.signalModification();
}

Trace.prototype.traceeRemoved = function() {
	this._traceeId = undefined;
}